---
title: "NES Pennsylvania Construction & Industry"
output: 
 flexdashboard::flex_dashboard:
   orientation: rows
   source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
#knitr::opts_knit$set(root.dir = normalizePath())
knitr::opts_chunk$set(echo = FALSE)
```


```{r context="setup", include=FALSE}
library(shiny)
library(ggplot2)
library(dplyr)
library(tidyr)
library(splines)
library(stringr)
library(RColorBrewer)
library(reshape2)
library(plotly)
library(leaflet)
require(rgdal)
require(leaflet.extras)
require(readxl)

```


```{r data}

## load raw data
#data <- read.csv("nes_selectdata2.csv")
#data <- read.csv("/Users/sorme/OneDrive/Documents/GitHub/final_sormehy/nes_selectdata.csv")
#data <- read.csv("nes_selectdata.csv")
data <- read.csv("nes_extratrim.csv")
#data <- read.csv("~/sormehy_final/nes_trimmed.csv")

## Make the data easier to read for the user
nes_st0418_p <- data %>% mutate(Industry.Title = ifelse(NAICS == 23, 'Construction',
                  ifelse(NAICS == 4853, 'Taxi & Limousine Service', ifelse(NAICS == 484, 'Truck Transportation', ifelse(NAICS == 4841, 'General Freight Trucking',
                  ifelse(NAICS == 48411, 'General Freight Trucking, Local', ifelse(NAICS == 48412, 'General Freight Trucking, Long-Distance', 
                  ifelse(NAICS == 4842, 'Specialized Freight Trucking', ifelse(NAICS == 236, 'Construction of Buildings', 
                  ifelse(NAICS == 2361, 'Residential Building Construction', ifelse(NAICS == 2362, 'Nonresidential Building Construction', 
                  ifelse(NAICS == 237, 'Heavy & Civil Engineering Construction', ifelse(NAICS == 2371, 'Utility System Construction',
                  ifelse(NAICS == 2372 | 23721, 'Land Subdivision', ifelse(NAICS == 2373 | 23731, 'Highway, Street, & Bridge Construction', 
                  ifelse(NAICS == 2379 | 23799, 'Other Heavy & Civ Eng Construction', ifelse(NAICS == 238, "Specialty Trade Contractors",
                    ifelse(NAICS == 2381, "Foundation, Structure, & Building Exterior Contractors",
                    ifelse(NAICS == 2382, "Building Equipment Contractors",
                    ifelse(NAICS == 23821, "Electrical Contractors and Other Wiring Installation Contractors",
                    ifelse(NAICS == 23822, "Plumbing, Heating, and Air-Conditioning Contractors",
                    ifelse(NAICS == 23829, "Other Building Equipment Contractors",
                    ifelse(NAICS == 2383, "Building Finishing Contractors",
                    ifelse(NAICS == 2389, "Other Specialty Trade Contractors"))))))))))))))))))))))))


#construction <- pa.ind.emp.raw %>%
#  filter(str_detect(NAICS, "^23"))


NAICS.Categories = c("^4853", "^23", "^48")
Big.Industries = c('Taxi & Limousine Service', 'Construction', 'Truck Transportation')
Count.Type = c("Total_RCPTOT", "Total_ESTAB")
Ind.Industries = c("Taxi and Limousine Service", "Truck Transportation", "General Freight Trucking", "General Freight Trucking, Local", 
           "General Freight Trucking, Long-Distance", "Specialized Freight Trucking", "Construction", "Construction of Buildings", 
           "Residential Building Construction", "Nonresidential Building Construction", "Heavy and Civil Engineering Construction",
           "Utility System Construction", "Land Subdivision-1", "Land Subdivision-2", "Highway, Street, and Bridge Construction-1",
           "Highway, Street, and Bridge Construction-2", "Other Heavy and Civil Engineering Construction-1", "Other Heavy and Civil Engineering Construction-2",
           "Specialty Trade Contractors", "Foundation, Structure, & Building Exterior Contractors", "Building Equipment Contractors", 
           "Electrical Contractors and Other Wiring Installation Contractors", "Plumbing, Heating, and Air-Conditioning Contractors",
           "Other Building Equipment Contractors", "Building Finishing Contractors", "Other Specialty Trade Contractors")
State.op <- c("Pennsylvania", "Ohio", "Illinois", "Montana")


## PICK THE THREE out of FOUR STATES FOR COMPARISON
nes_st0418_p <- nes_st0418_p %>% mutate(ST_n = ifelse(ST == 17, 'Illinois', ifelse(ST == 39, 'Ohio', ifelse(ST == 42, 'Pennsylvania', ifelse(ST == 30, 'Montana', 'NaN')))))

#print(getwd())

```

Inputs Column {.sidebar}
-----------------------------------------------------------------------

```{r context="render"}

selectInput("naics_var", label = "Select NAICS Category:", choices = NAICS.Categories)

selectInput("big_ind", label = "Select Industry Title Categories:", choices = Big.Industries)

selectInput("count_type", label = "Select Type of Count:", choices = Count.Type)

#selectInput("ind_ind", label = "Select Detailed Industries:", choices = Ind.Industries)

checkboxGroupInput("ch_state", "Select States to Compare:", choices = State.op,
                  selected = c("Pennsylvania", "Ohio", "Illinois"), inline = TRUE
                  )

checkboxGroupInput("ind_ind", "Select Detailed Industries:", choices = Ind.Industries,
                  selected = c("Taxi and Limousine Service", "Truck Transportation", "Construction"), inline = TRUE
                  )



```


Page with Tabset {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Segment Plot of Number of Workers in Given Industry

```{r context="server"}

# industry_subset <- reactive({
#   nes_st0418_p %>%
#     filter(
#       str_detect(Industry.Title, input$ind_ind)
#     )
# })

# industry_subset <- reactive({
#     filter(nes_st0418_p,
#       Industry.Title %in% input$ind_ind |
#           ST_n == input$ch_state
#     )
# })

# industry_subset <- reactive({
#     nes_st0418_p[nes_st0418_p$Industry.Title %in% input$ind_ind,]
#              nes_st0418_p[nes_st0418_p$ST_n %in% input$ch_state,]
# })

industry_subset <- reactive({
    nes_st0418_p[nes_st0418_p$Industry.Title %in% input$ind_ind & nes_st0418_p$ST_n %in% input$ch_state,]
})


# state_subset <- reactive({
#   nes_st0418_p %>%
#     filter(
#       ST_n %in% input$ch_state)
#     )
# })

data_year <- reactive({
    filter(data, 
      input$big_ind
    )
})

count_type <- reactive({
    filter(nes_st0418_p, input$count_type)
})

output$scatter <- renderPlotly({
  ggplotly(ggplot(industry_subset(), mapping = aes(x = Industry.Title, xend = Industry.Title, y = Emp.2018, yend = 0, color = Industry.Title)) + 
    geom_point(size = 3) +
  geom_segment(size = 1)+
  coord_flip() + 
  labs(x='', y='Number of Employees', title='Pennsylvanians Employed in Given Industry'))
})

output$scatter.ordered <- renderPlotly({
  ggplotly(ggplot(data = industry_subset(), mapping = aes(x = reorder(Industry.Title, -Emp.2018), xend = reorder(Industry.Title, -Emp.2018), y = Emp.2018, yend = 0, color = Industry.Title)) + 
    geom_point() +
      geom_segment()+
    coord_flip() + 
    labs(x='', y='Number of Employees', title='Pennsylvanians Employed in Given Industry') + theme(legend.position = "none"))
})

output$mod.plot <- renderPlotly({
  
  if(input$employed_year == "Emp.2018"){
    ggplotly(ggplot(data = industry_subset(), mapping = aes(x = reorder(Industry.Title, -Emp.2018), xend = reorder(Industry.Title, -Emp.2018), y = Emp.2018, yend = 0, color = Industry.Title)) + 
    geom_point() +
      geom_segment()+
    coord_flip() + 
    labs(x='', y='Number of Employees', title='Pennsylvanians Employed in Given Industry') + theme(legend.position = "none"))
  }
  else {
    ggplotly(ggplot(data = industry_subset(), mapping = aes(x = reorder(Industry.Title, -Emp.2028), xend = reorder(Industry.Title, -Emp.2028), y = Emp.2028, yend = 0, color = Industry.Title)) + 
    geom_point() +
      geom_segment()+
    coord_flip() + 
    labs(x='', y='Number of Employees', title='Pennsylvanians Employed in Given Industry') + theme(legend.position = "none"))
  }
    
})

output$compare.plot <- renderPlotly({
    if(input$count_type == 'Receipts'){
  ggplotly(ggplot(data = industry_subset(), mapping = aes(x=Year, y=(Total_RCPTOT/1000000), color = ST_n)) +
    geom_line() + geom_point() +
  labs(title='Industry Growth Over Time (2004 - 2018)', 
       x = 'Year', y = 'Total Receipts (in millions) in Given Industry and State') +
    facet_wrap('Industry.Title') + theme(
plot.title = element_text(size=12, face="bold"),
axis.title.x = element_text(size=13),
axis.title.y = element_text(size=13)))
    }else{
        ggplotly(ggplot(data = industry_subset(), mapping = aes(x=Year, y=(Total_ESTAB/10000), color = ST_n)) +
    geom_line() + geom_point() +
  labs(title='Industry Growth Over Time (2004 - 2018)', 
       x = 'Year', y = 'Total Establishments (in 10,000s)') +
    facet_wrap('Industry.Title') + theme(
plot.title = element_text(size=12, face="bold"),
axis.title.x = element_text(size=13),
axis.title.y = element_text(size=13)))
    }
})

# p3 <- nes_st0418_p %>% group_by(ST, NAICS) %>%
#   filter(NAICS == 23 | NAICS == 484 | NAICS == 4853) %>%
#   ggplot(aes(x=Year, y=(Total_RCPTOT/1000000), color = ST_n)) +
#     geom_line() + geom_point() +
#   labs(title='Industry Growth Over Time (2004 - 2018)',
#        x = 'Year', y = 'Total Receipts (in millions) in Given Industry and State') +
#     facet_wrap('Industry.Title') + theme(
# plot.title = element_text(size=12, face="bold"),
# axis.title.x = element_text(size=13),
# axis.title.y = element_text(size=13)
# )
# 
# # Turn it interactive with ggplotly
# p3.p <- ggplotly(p3)
# p3.p


#renderPlotly({
#  plot_ly(data, x=~data[[input$naics_var]], )
#})

#ggplot(data = construction, mapping = aes(x = Industry.Title, xend = Industry.Title, y = Emp.2018, yend = 0)) + geom_point() +
#  geom_segment()+
#  coord_flip() + 
#  labs(x='', y='Current Count', title='Employed in Construction')

```

```{r context="render"}
#plotlyOutput("scatter.ordered")
#plotlyOutput("mod.plot")
plotlyOutput("compare.plot")
```


Column {data-width=350}
-----------------------------------------------------------------------

### Industry Details {data-width=400}

```{r}
renderTable({
  industry_subset()
})
```



